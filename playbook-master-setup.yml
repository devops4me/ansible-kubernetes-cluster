---
#
# This playbook will take a master node that has undergone the basic setup applied
# in the playbook-nodes-setup.yml and makes a single node the kubernetes master.
#
# The prerequisites are
#
#   - the playbook-all-nodes.yml has been run
#   - (either) there has been no attempt to make this node a master
#   - (or)     previous attempts have been reset with playbook-master-reset.yml
#
# Once you've checked that the master configuration you can then procedd to join
# worker nodes to the cluster with the playbook-worker-join.yml
#

- hosts: master
  become: true
  name: Setup control plane and make kubectl talk to cluster
  tasks:

  - name: Initialize the Kubernetes control plane using kubeadm
    become: true
    command: kubeadm init --control-plane-endpoint={{ ansible_hostname }}
    register: kubeadm_init_output

  - name: Store the Logs generated by the kubeadm cluster initialize command
    local_action: copy content={{ kubeadm_init_output.stdout }} dest=kubeadm-init-output.log backup=yes
    become: false

  - name: Create the .kube directory to hold the kubectl configuration
    become: false
    file:
      path: /home/ubuntu/.kube
      state: directory
      owner: ubuntu
      group: docker
      mode: 0755

  - name: Copy the kubectl configuration for the local user
    become: true
    command: "{{ item }}"
    with_items:
     - cp -i /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
     - chown ubuntu:docker /home/ubuntu/.kube/config

  - name: Fetch kubectl config for laptop (ansible host) to use
    fetch:
      src: /etc/kubernetes/admin.conf
      dest: kubectl-configuration.yml
      backup: yes
      flat: yes

  - name: Copy to local user so laptop kubectl connects to cluster
    become: false
    copy:
      src: kubectl-configuration.yml
      dest: ~/.kube/config
      backup: yes
    delegate_to: localhost

  - name: Install calico pod networking using kubectl on the master
    become: false
    command: kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
